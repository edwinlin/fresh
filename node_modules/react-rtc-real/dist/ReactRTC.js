"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _react = _interopRequireDefault(require("react"));

var _socketConnection = require("./socketConnection.js");

require("regenerator-runtime/runtime");

require("core-js/stable");

// var _cameraIcon = _interopRequireDefault(require("../assets/images/camera-icon.png"));

// var _phoneIcon = _interopRequireDefault(require("../assets/images/phone-icon.png"));

// var _stopIcon = _interopRequireDefault(require("../assets/images/stop-icon.png"));

// var _reactrtc = _interopRequireDefault(require("../assets/images/reactrtc.png"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

// console.log('testing here ===>', this.onMessage)
var ReactRTC =
/*#__PURE__*/
function (_React$Component) {
  _inherits(ReactRTC, _React$Component);

  function ReactRTC() {
    var _this;

    _classCallCheck(this, ReactRTC);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(ReactRTC).call(this));
    _this.state = {
      sessionConstraints: {
        video: true,
        audio: false
      },
      localStream: null
    };
    _this.getUserMedia = _this.getUserMedia.bind(_assertThisInitialized(_this));
    _this.handleUserMedia = _this.handleUserMedia.bind(_assertThisInitialized(_this));
    _this.stopStream = _this.stopStream.bind(_assertThisInitialized(_this));
    _this.onIceHandler = _this.onIceHandler.bind(_assertThisInitialized(_this));
    _this.onTrackHandler = _this.onTrackHandler.bind(_assertThisInitialized(_this));
    _this.onNegotiationNeededHandler = _this.onNegotiationNeededHandler.bind(_assertThisInitialized(_this));
    _this.callButtonGetTracks = _this.callButtonGetTracks.bind(_assertThisInitialized(_this));
    _this.socketConnection = new WebSocket('wss://edwintest.localtunnel.me');
    _this.iceServerConfig = {
      iceServers: [{
        urls: 'stun:stun.l.google.com:19302'
      }]
    };
    _this.peerConnection = new RTCPeerConnection(_this.iceServerConfig);
    return _this;
  } // sessionConstraints = {video:true, audio:false}


  _createClass(ReactRTC, [{
    key: "handleUserMedia",
    value: function handleUserMedia(mediaStream) {
      var reactLogo = document.querySelector('.react-rtc__logo');
      reactLogo.style.display = 'none';
      this.setState({
        localStream: mediaStream
      }, function () {
        console.log('hitting setState for handleUserMedia');
      }); // console.log('localstream', this.state.localStream)

      var localVideo = document.querySelector('#localVideo');
      var localStream = this.state.localStream;
      localVideo.srcObject = localStream;
    }
  }, {
    key: "getUserMedia",
    value: function getUserMedia(event) {
      navigator.mediaDevices.getUserMedia(this.state.sessionConstraints).then(this.handleUserMedia)["catch"](function (err) {
        console.error('Err:'.err);
      });
    }
  }, {
    key: "stopStream",
    value: function stopStream(event) {
      var endVideoStream = this.state.localStream.getVideoTracks()[0].stop(); // const endAudioStream = this.state.localStream.getAudioTracks()[0].stop()

      this.setState({
        localStream: endVideoStream
      }); // NOTE: will need to add audio tracks later

      console.log('hitting both endVideoStream'); // this.setState({localStream:endAudioStream})
    }
  }, {
    key: "callButtonGetTracks",
    value: function callButtonGetTracks() {
      var _this2 = this;

      return regeneratorRuntime.async(function callButtonGetTracks$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              console.log('looking for localStream -->', this.state.localStream);
              _context.next = 3;
              return regeneratorRuntime.awrap(this.state.localStream.getTracks().forEach(function (mediaStreamTrack) {
                console.log('hitting forEach getTracks');

                _this2.peerConnection.addTrack(mediaStreamTrack);
              }));

            case 3:
            case "end":
              return _context.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "onIceHandler",
    value: function onIceHandler(RTCPeerConnectionIceEvent) {
      if (RTCPeerConnectionIceEvent.candidate) {
        var type = RTCPeerConnectionIceEvent.type,
            candidate = RTCPeerConnectionIceEvent.candidate;
        this.socketConnection.send(JSON.stringify({
          type: type,
          candidate: candidate
        }));
      }
    }
  }, {
    key: "onTrackHandler",
    value: function onTrackHandler(event) {
      var remoteVideo = document.querySelector('#remoteVideo');
      remoteVideo.srcObject = new MediaStream([event.track]);
      remoteVideo.style.display = 'block';
    }
  }, {
    key: "onNegotiationNeededHandler",
    value: function onNegotiationNeededHandler(negotiationNeededEvent) {
      var offer;
      return regeneratorRuntime.async(function onNegotiationNeededHandler$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              console.log('hitting onNegotiationNeededHandler');
              _context2.prev = 1;
              _context2.next = 4;
              return regeneratorRuntime.awrap(this.peerConnection.createOffer());

            case 4:
              offer = _context2.sent;
              console.log('offer is about to be created before sending');
              _context2.next = 8;
              return regeneratorRuntime.awrap(this.peerConnection.setLocalDescription(offer));

            case 8:
              console.log('About to send data');
              this.socketConnection.send(JSON.stringify(this.peerConnection.localDescription));
              _context2.next = 15;
              break;

            case 12:
              _context2.prev = 12;
              _context2.t0 = _context2["catch"](1);
              console.error('ERROR:', _context2.t0);

            case 15:
            case "end":
              return _context2.stop();
          }
        }
      }, null, this, [[1, 12]]);
    }
  }, {
    key: "componentDidMount",
    value: function componentDidMount() {
      var _this3 = this;

      this.socketConnection.onopen = function () {
        console.log('connected');
      };

      this.socketConnection.onmessage = function (event) {
        console.log('event', event); // console.log('eventdata', JSON.parse(event.data))
        // testing = OnMessage()
        // console.log('hitting')

        var messageData = JSON.parse(event.data);
        console.log('messageData', messageData);
        (0, _socketConnection.onMessage)(messageData, _this3.peerConnection, _this3.socketConnection, _this3.state.sessionConstraints);
      };

      this.socketConnection.onclose = function (event) {
        // console.log('Socket is closed. Reconnecting will be attempted in 1 second', event.reason);
        // setTimeout(()=>{
        //   connect();
        // },1000)
        console.log('outside reconnect');
      };

      this.socketConnection.onerror = function (err) {
        console.error('Socket encountered this error ==>', err.message, 'Closing socket');
      };
    }
  }, {
    key: "render",
    value: function render() {
      // move these to componentDidmount
      this.peerConnection.onicecandidate = this.onIceHandler;
      this.peerConnection.ontrack = this.onTrackHandler;
      this.peerConnection.onnegotiationneeded = this.onNegotiationNeededHandler;
      return _react["default"].createElement("div", {
        className: "react-rtc"
      }, "Hii", _react["default"].createElement("div", {
        className: "videoContainer"
      }, _react["default"].createElement("img", {
        className: "react-rtc__logo",
        src: _reactrtc["default"],
        alt: ""
      }), _react["default"].createElement("video", {
        id: "localVideo",
        autoPlay: true
      }), _react["default"].createElement("video", {
        id: "remoteVideo",
        autoPlay: true
      })), _react["default"].createElement("section", {
        className: "button-container"
      }, _react["default"].createElement("div", {
        className: "button button--start-color",
        onClick: this.getUserMedia
      }, _react["default"].createElement("img", {
        className: "icon icon--start",
        src: _cameraIcon["default"],
        alt: ""
      })), _react["default"].createElement("div", {
        className: "button button--stop-color",
        onClick: this.stopStream
      }, _react["default"].createElement("img", {
        className: "icon icon--stop",
        src: _stopIcon["default"]
      })), _react["default"].createElement("div", {
        className: "button button--call-color",
        onClick: this.callButtonGetTracks
      }, _react["default"].createElement("img", {
        className: "icon icon--call",
        src: _phoneIcon["default"]
      }))));
    }
  }]);

  return ReactRTC;
}(_react["default"].Component);

var _default = ReactRTC;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SZWFjdFJUQy5qcyJdLCJuYW1lcyI6WyJSZWFjdFJUQyIsInN0YXRlIiwic2Vzc2lvbkNvbnN0cmFpbnRzIiwidmlkZW8iLCJhdWRpbyIsImxvY2FsU3RyZWFtIiwiZ2V0VXNlck1lZGlhIiwiYmluZCIsImhhbmRsZVVzZXJNZWRpYSIsInN0b3BTdHJlYW0iLCJvbkljZUhhbmRsZXIiLCJvblRyYWNrSGFuZGxlciIsIm9uTmVnb3RpYXRpb25OZWVkZWRIYW5kbGVyIiwiY2FsbEJ1dHRvbkdldFRyYWNrcyIsInNvY2tldENvbm5lY3Rpb24iLCJXZWJTb2NrZXQiLCJpY2VTZXJ2ZXJDb25maWciLCJpY2VTZXJ2ZXJzIiwidXJscyIsInBlZXJDb25uZWN0aW9uIiwiUlRDUGVlckNvbm5lY3Rpb24iLCJtZWRpYVN0cmVhbSIsInJlYWN0TG9nbyIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvciIsInN0eWxlIiwiZGlzcGxheSIsInNldFN0YXRlIiwiY29uc29sZSIsImxvZyIsImxvY2FsVmlkZW8iLCJzcmNPYmplY3QiLCJldmVudCIsIm5hdmlnYXRvciIsIm1lZGlhRGV2aWNlcyIsInRoZW4iLCJlcnIiLCJlcnJvciIsImVuZFZpZGVvU3RyZWFtIiwiZ2V0VmlkZW9UcmFja3MiLCJzdG9wIiwiZ2V0VHJhY2tzIiwiZm9yRWFjaCIsIm1lZGlhU3RyZWFtVHJhY2siLCJhZGRUcmFjayIsIlJUQ1BlZXJDb25uZWN0aW9uSWNlRXZlbnQiLCJjYW5kaWRhdGUiLCJ0eXBlIiwic2VuZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZW1vdGVWaWRlbyIsIk1lZGlhU3RyZWFtIiwidHJhY2siLCJuZWdvdGlhdGlvbk5lZWRlZEV2ZW50IiwiY3JlYXRlT2ZmZXIiLCJvZmZlciIsInNldExvY2FsRGVzY3JpcHRpb24iLCJsb2NhbERlc2NyaXB0aW9uIiwib25vcGVuIiwib25tZXNzYWdlIiwibWVzc2FnZURhdGEiLCJwYXJzZSIsImRhdGEiLCJvbmNsb3NlIiwib25lcnJvciIsIm1lc3NhZ2UiLCJvbmljZWNhbmRpZGF0ZSIsIm9udHJhY2siLCJvbm5lZ290aWF0aW9ubmVlZGVkIiwicmVhY3RSVENMb2dvIiwiY2FtZXJhSWNvbiIsInN0b3BJY29uIiwicGhvbmVJY29uIiwiUmVhY3QiLCJDb21wb25lbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBO0lBQ01BLFE7Ozs7O0FBQ0osc0JBQWM7QUFBQTs7QUFBQTs7QUFDWjtBQUNBLFVBQUtDLEtBQUwsR0FBYTtBQUNYQyxNQUFBQSxrQkFBa0IsRUFBRTtBQUFFQyxRQUFBQSxLQUFLLEVBQUUsSUFBVDtBQUFlQyxRQUFBQSxLQUFLLEVBQUU7QUFBdEIsT0FEVDtBQUVYQyxNQUFBQSxXQUFXLEVBQUU7QUFGRixLQUFiO0FBS0EsVUFBS0MsWUFBTCxHQUFvQixNQUFLQSxZQUFMLENBQWtCQyxJQUFsQiwrQkFBcEI7QUFDQSxVQUFLQyxlQUFMLEdBQXVCLE1BQUtBLGVBQUwsQ0FBcUJELElBQXJCLCtCQUF2QjtBQUNBLFVBQUtFLFVBQUwsR0FBa0IsTUFBS0EsVUFBTCxDQUFnQkYsSUFBaEIsK0JBQWxCO0FBQ0EsVUFBS0csWUFBTCxHQUFvQixNQUFLQSxZQUFMLENBQWtCSCxJQUFsQiwrQkFBcEI7QUFDQSxVQUFLSSxjQUFMLEdBQXNCLE1BQUtBLGNBQUwsQ0FBb0JKLElBQXBCLCtCQUF0QjtBQUNBLFVBQUtLLDBCQUFMLEdBQWtDLE1BQUtBLDBCQUFMLENBQWdDTCxJQUFoQywrQkFBbEM7QUFHQSxVQUFLTSxtQkFBTCxHQUEyQixNQUFLQSxtQkFBTCxDQUF5Qk4sSUFBekIsK0JBQTNCO0FBQ0EsVUFBS08sZ0JBQUwsR0FBd0IsSUFBSUMsU0FBSixDQUFjLGdDQUFkLENBQXhCO0FBQ0EsVUFBS0MsZUFBTCxHQUF1QjtBQUNyQkMsTUFBQUEsVUFBVSxFQUFFLENBQUM7QUFBRUMsUUFBQUEsSUFBSSxF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QUFHLEVBQUUrRDtBQUF0QyxRQURGLENBWEYsRUFjRTtBQUNFLFFBQUEsU0FBUyxFQUFDLDJCQURaO0FBRUUsUUFBQSxPQUFPLEVBQUUsS0FBSzNEO0FBRmhCLFNBSUU7QUFBSyxRQUFBLFNBQVMsRUFBQyxpQkFBZjtBQUFpQyxRQUFBLEdBQUcsRUFBRTREO0FBQXRDLFFBSkYsQ0FkRixDQVBGLENBREY7QUErQkQ7Ozs7RUF6S29CQyxrQkFBTUMsUzs7ZUE0S2QzRSxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IG9uTWVzc2FnZSB9IGZyb20gJy4vc29ja2V0Q29ubmVjdGlvbi5qcyc7XG5pbXBvcnQgJ3JlZ2VuZXJhdG9yLXJ1bnRpbWUvcnVudGltZSc7XG5pbXBvcnQgJ2NvcmUtanMvc3RhYmxlJztcbmltcG9ydCBjYW1lcmFJY29uIGZyb20gJy4uL2Fzc2V0cy9pbWFnZXMvY2FtZXJhLWljb24ucG5nJztcbmltcG9ydCBwaG9uZUljb24gZnJvbSAnLi4vYXNzZXRzL2ltYWdlcy9waG9uZS1pY29uLnBuZyc7XG5pbXBvcnQgc3RvcEljb24gZnJvbSAnLi4vYXNzZXRzL2ltYWdlcy9zdG9wLWljb24ucG5nJztcbmltcG9ydCByZWFjdFJUQ0xvZ28gZnJvbSAnLi4vYXNzZXRzL2ltYWdlcy9yZWFjdHJ0Yy5wbmcnO1xuXG4vLyBjb25zb2xlLmxvZygndGVzdGluZyBoZXJlID09PT4nLCB0aGlzLm9uTWVzc2FnZSlcbmNsYXNzIFJlYWN0UlRDIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgc2Vzc2lvbkNvbnN0cmFpbnRzOiB7IHZpZGVvOiB0cnVlLCBhdWRpbzogZmFsc2UgfSxcbiAgICAgIGxvY2FsU3RyZWFtOiBudWxsXG4gICAgfTtcblxuICAgIHRoaXMuZ2V0VXNlck1lZGlhID0gdGhpcy5nZXRVc2VyTWVkaWEuYmluZCh0aGlzKTtcbiAgICB0aGlzLmhhbmRsZVVzZXJNZWRpYSA9IHRoaXMuaGFuZGxlVXNlck1lZGlhLmJpbmQodGhpcyk7XG4gICAgdGhpcy5zdG9wU3RyZWFtID0gdGhpcy5zdG9wU3RyZWFtLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vbkljZUhhbmRsZXIgPSB0aGlzLm9uSWNlSGFuZGxlci5iaW5kKHRoaXMpO1xuICAgIHRoaXMub25UcmFja0hhbmRsZXIgPSB0aGlzLm9uVHJhY2tIYW5kbGVyLmJpbmQodGhpcyk7XG4gICAgdGhpcy5vbk5lZ290aWF0aW9uTmVlZGVkSGFuZGxlciA9IHRoaXMub25OZWdvdGlhdGlvbk5lZWRlZEhhbmRsZXIuYmluZChcbiAgICAgIHRoaXNcbiAgICApO1xuICAgIHRoaXMuY2FsbEJ1dHRvbkdldFRyYWNrcyA9IHRoaXMuY2FsbEJ1dHRvbkdldFRyYWNrcy5iaW5kKHRoaXMpO1xuICAgIHRoaXMuc29ja2V0Q29ubmVjdGlvbiA9IG5ldyBXZWJTb2NrZXQoJ3dzczovL2Vkd2ludGVzdC5sb2NhbHR1bm5lbC5tZScpO1xuICAgIHRoaXMuaWNlU2VydmVyQ29uZmlnID0ge1xuICAgICAgaWNlU2VydmVyczogW3sgdXJsczogJ3N0dW46c3R1bi5sLmdvb2dsZS5jb206MTkzMDInIH1dXG4gICAgfTtcbiAgICB0aGlzLnBlZXJDb25uZWN0aW9uID0gbmV3IFJUQ1BlZXJDb25uZWN0aW9uKHRoaXMuaWNlU2VydmVyQ29uZmlnKTtcbiAgfVxuXG4gIC8vIHNlc3Npb25Db25zdHJhaW50cyA9IHt2aWRlbzp0cnVlLCBhdWRpbzpmYWxzZX1cblxuICBoYW5kbGVVc2VyTWVkaWEobWVkaWFTdHJlYW0pIHtcbiAgICBjb25zdCByZWFjdExvZ28gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcucmVhY3QtcnRjX19sb2dvJyk7XG4gICAgcmVhY3RMb2dvLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgdGhpcy5zZXRTdGF0ZSh7IGxvY2FsU3RyZWFtOiBtZWRpYVN0cmVhbSB9LCAoKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnaGl0dGluZyBzZXRTdGF0ZSBmb3IgaGFuZGxlVXNlck1lZGlhJyk7XG4gICAgfSk7XG4gICAgLy8gY29uc29sZS5sb2coJ2xvY2Fsc3RyZWFtJywgdGhpcy5zdGF0ZS5sb2NhbFN0cmVhbSlcbiAgICBjb25zdCBsb2NhbFZpZGVvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2xvY2FsVmlkZW8nKTtcbiAgICBjb25zdCB7IGxvY2FsU3RyZWFtIH0gPSB0aGlzLnN0YXRlO1xuICAgIGxvY2FsVmlkZW8uc3JjT2JqZWN0ID0gbG9jYWxTdHJlYW07XG4gIH1cblxuICBnZXRVc2VyTWVkaWEoZXZlbnQpIHtcbiAgICBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzXG4gICAgICAuZ2V0VXNlck1lZGlhKHRoaXMuc3RhdGUuc2Vzc2lvbkNvbnN0cmFpbnRzKVxuICAgICAgLnRoZW4odGhpcy5oYW5kbGVVc2VyTWVkaWEpXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyOicuZXJyKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc3RvcFN0cmVhbShldmVudCkge1xuICAgIGNvbnN0IGVuZFZpZGVvU3RyZWFtID0gdGhpcy5zdGF0ZS5sb2NhbFN0cmVhbS5nZXRWaWRlb1RyYWNrcygpWzBdLnN0b3AoKTtcbiAgICAvLyBjb25zdCBlbmRBdWRpb1N0cmVhbSA9IHRoaXMuc3RhdGUubG9jYWxTdHJlYW0uZ2V0QXVkaW9UcmFja3MoKVswXS5zdG9wKClcbiAgICB0aGlzLnNldFN0YXRlKHsgbG9jYWxTdHJlYW06IGVuZFZpZGVvU3RyZWFtIH0pO1xuICAgIC8vIE5PVEU6IHdpbGwgbmVlZCB0byBhZGQgYXVkaW8gdHJhY2tzIGxhdGVyXG4gICAgY29uc29sZS5sb2coJ2hpdHRpbmcgYm90aCBlbmRWaWRlb1N0cmVhbScpO1xuXG4gICAgLy8gdGhpcy5zZXRTdGF0ZSh7bG9jYWxTdHJlYW06ZW5kQXVkaW9TdHJlYW19KVxuICB9XG5cbiAgYXN5bmMgY2FsbEJ1dHRvbkdldFRyYWNrcygpIHtcbiAgICBjb25zb2xlLmxvZygnbG9va2luZyBmb3IgbG9jYWxTdHJlYW0gLS0+JywgdGhpcy5zdGF0ZS5sb2NhbFN0cmVhbSk7XG4gICAgYXdhaXQgdGhpcy5zdGF0ZS5sb2NhbFN0cmVhbS5nZXRUcmFja3MoKS5mb3JFYWNoKG1lZGlhU3RyZWFtVHJhY2sgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2hpdHRpbmcgZm9yRWFjaCBnZXRUcmFja3MnKTtcbiAgICAgIHRoaXMucGVlckNvbm5lY3Rpb24uYWRkVHJhY2sobWVkaWFTdHJlYW1UcmFjayk7XG4gICAgfSk7XG4gIH1cblxuICBvbkljZUhhbmRsZXIoUlRDUGVlckNvbm5lY3Rpb25JY2VFdmVudCkge1xuICAgIGlmIChSVENQZWVyQ29ubmVjdGlvbkljZUV2ZW50LmNhbmRpZGF0ZSkge1xuICAgICAgY29uc3QgeyB0eXBlLCBjYW5kaWRhdGUgfSA9IFJUQ1BlZXJDb25uZWN0aW9uSWNlRXZlbnQ7XG4gICAgICB0aGlzLnNvY2tldENvbm5lY3Rpb24uc2VuZChKU09OLnN0cmluZ2lmeSh7IHR5cGUsIGNhbmRpZGF0ZSB9KSk7XG4gICAgfVxuICB9XG5cbiAgb25UcmFja0hhbmRsZXIoZXZlbnQpIHtcbiAgICBjb25zdCByZW1vdGVWaWRlbyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJyNyZW1vdGVWaWRlbycpO1xuICAgIHJlbW90ZVZpZGVvLnNyY09iamVjdCA9IG5ldyBNZWRpYVN0cmVhbShbZXZlbnQudHJhY2tdKTtcbiAgICByZW1vdGVWaWRlby5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgfVxuXG4gIGFzeW5jIG9uTmVnb3RpYXRpb25OZWVkZWRIYW5kbGVyKG5lZ290aWF0aW9uTmVlZGVkRXZlbnQpIHtcbiAgICBjb25zb2xlLmxvZygnaGl0dGluZyBvbk5lZ290aWF0aW9uTmVlZGVkSGFuZGxlcicpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBvZmZlciA9IGF3YWl0IHRoaXMucGVlckNvbm5lY3Rpb24uY3JlYXRlT2ZmZXIoKTtcbiAgICAgIGNvbnNvbGUubG9nKCdvZmZlciBpcyBhYm91dCB0byBiZSBjcmVhdGVkIGJlZm9yZSBzZW5kaW5nJyk7XG5cbiAgICAgIGF3YWl0IHRoaXMucGVlckNvbm5lY3Rpb24uc2V0TG9jYWxEZXNjcmlwdGlvbihvZmZlcik7XG5cbiAgICAgIGNvbnNvbGUubG9nKCdBYm91dCB0byBzZW5kIGRhdGEnKTtcblxuICAgICAgdGhpcy5zb2NrZXRDb25uZWN0aW9uLnNlbmQoXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMucGVlckNvbm5lY3Rpb24ubG9jYWxEZXNjcmlwdGlvbilcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFUlJPUjonLCBlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIHRoaXMuc29ja2V0Q29ubmVjdGlvbi5vbm9wZW4gPSAoKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnY29ubmVjdGVkJyk7XG4gICAgfTtcbiAgICB0aGlzLnNvY2tldENvbm5lY3Rpb24ub25tZXNzYWdlID0gZXZlbnQgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2V2ZW50JywgZXZlbnQpO1xuICAgICAgLy8gY29uc29sZS5sb2coJ2V2ZW50ZGF0YScsIEpTT04ucGFyc2UoZXZlbnQuZGF0YSkpXG5cbiAgICAgIC8vIHRlc3RpbmcgPSBPbk1lc3NhZ2UoKVxuICAgICAgLy8gY29uc29sZS5sb2coJ2hpdHRpbmcnKVxuICAgICAgY29uc3QgbWVzc2FnZURhdGEgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpO1xuICAgICAgY29uc29sZS5sb2coJ21lc3NhZ2VEYXRhJywgbWVzc2FnZURhdGEpO1xuICAgICAgb25NZXNzYWdlKFxuICAgICAgICBtZXNzYWdlRGF0YSxcbiAgICAgICAgdGhpcy5wZWVyQ29ubmVjdGlvbixcbiAgICAgICAgdGhpcy5zb2NrZXRDb25uZWN0aW9uLFxuICAgICAgICB0aGlzLnN0YXRlLnNlc3Npb25Db25zdHJhaW50c1xuICAgICAgKTtcbiAgICB9O1xuICAgIHRoaXMuc29ja2V0Q29ubmVjdGlvbi5vbmNsb3NlID0gZXZlbnQgPT4ge1xuICAgICAgLy8gY29uc29sZS5sb2coJ1NvY2tldCBpcyBjbG9zZWQuIFJlY29ubmVjdGluZyB3aWxsIGJlIGF0dGVtcHRlZCBpbiAxIHNlY29uZCcsIGV2ZW50LnJlYXNvbik7XG4gICAgICAvLyBzZXRUaW1lb3V0KCgpPT57XG4gICAgICAvLyAgIGNvbm5lY3QoKTtcbiAgICAgIC8vIH0sMTAwMClcbiAgICAgIGNvbnNvbGUubG9nKCdvdXRzaWRlIHJlY29ubmVjdCcpO1xuICAgIH07XG5cbiAgICB0aGlzLnNvY2tldENvbm5lY3Rpb24ub25lcnJvciA9IGVyciA9PiB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAnU29ja2V0IGVuY291bnRlcmVkIHRoaXMgZXJyb3IgPT0+JyxcbiAgICAgICAgZXJyLm1lc3NhZ2UsXG4gICAgICAgICdDbG9zaW5nIHNvY2tldCdcbiAgICAgICk7XG4gICAgfTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICAvLyBtb3ZlIHRoZXNlIHRvIGNvbXBvbmVudERpZG1vdW50XG4gICAgdGhpcy5wZWVyQ29ubmVjdGlvbi5vbmljZWNhbmRpZGF0ZSA9IHRoaXMub25JY2VIYW5kbGVyO1xuICAgIHRoaXMucGVlckNvbm5lY3Rpb24ub250cmFjayA9IHRoaXMub25UcmFja0hhbmRsZXI7XG4gICAgdGhpcy5wZWVyQ29ubmVjdGlvbi5vbm5lZ290aWF0aW9ubmVlZGVkID0gdGhpcy5vbk5lZ290aWF0aW9uTmVlZGVkSGFuZGxlcjtcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cInJlYWN0LXJ0Y1wiPlxuICAgICAgICBIaWlcbiAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJ2aWRlb0NvbnRhaW5lclwiPlxuICAgICAgICAgIDxpbWcgY2xhc3NOYW1lPVwicmVhY3QtcnRjX19sb2dvXCIgc3JjPXtyZWFjdFJUQ0xvZ299IGFsdD1cIlwiIC8+XG4gICAgICAgICAgPHZpZGVvIGlkPVwibG9jYWxWaWRlb1wiIGF1dG9QbGF5IC8+XG4gICAgICAgICAgPHZpZGVvIGlkPVwicmVtb3RlVmlkZW9cIiBhdXRvUGxheSAvPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgPHNlY3Rpb24gY2xhc3NOYW1lPVwiYnV0dG9uLWNvbnRhaW5lclwiPlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGNsYXNzTmFtZT1cImJ1dHRvbiBidXR0b24tLXN0YXJ0LWNvbG9yXCJcbiAgICAgICAgICAgIG9uQ2xpY2s9e3RoaXMuZ2V0VXNlck1lZGlhfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIHsvKiA8ZGl2IFxuICAgICAgICAgICAgY2xhc3NOYW1lPSdpY29uIGljb24tLXN0YXJ0J1xuICAgICAgICAgICAgc3R5bGU9e3tiYWNrZ3JvdW5kSW1hZ2U6IGNhbWVyYUljb259fVxuICAgICAgICAgICAgPjwvZGl2PiAqL31cbiAgICAgICAgICAgIDxpbWcgY2xhc3NOYW1lPVwiaWNvbiBpY29uLS1zdGFydFwiIHNyYz17Y2FtZXJhSWNvbn0gYWx0PVwiXCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImJ1dHRvbiBidXR0b24tLXN0b3AtY29sb3JcIiBvbkNsaWNrPXt0aGlzLnN0b3BTdHJlYW19PlxuICAgICAgICAgICAgPGltZyBjbGFzc05hbWU9XCJpY29uIGljb24tLXN0b3BcIiBzcmM9e3N0b3BJY29ufSAvPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGNsYXNzTmFtZT1cImJ1dHRvbiBidXR0b24tLWNhbGwtY29sb3JcIlxuICAgICAgICAgICAgb25DbGljaz17dGhpcy5jYWxsQnV0dG9uR2V0VHJhY2tzfVxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxpbWcgY2xhc3NOYW1lPVwiaWNvbiBpY29uLS1jYWxsXCIgc3JjPXtwaG9uZUljb259IC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvc2VjdGlvbj5cbiAgICAgIDwvZGl2PlxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUmVhY3RSVEM7XG4iXX0=